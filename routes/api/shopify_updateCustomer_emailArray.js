var async = require('async'),
	keystone = require('keystone');
var request = require("request");
var sleep = require('sleep');

var emailArray = [
		"brett.dobrick@gmail.com","brian213@gmail.com","brians_od@yahoo.com","briansim121@comcast.net","brock.randy@gmail.com","brucenaumann55@yahoo.com","bryant.genevieve@gmail.com","bsatrom@gmail.com","bshpainting@yahoo.com","bsturmer@gmail.com","btotheeck@gmail.com","BuckeyeFaninMI@comcast.net","bwj42@yahoo.com","bworthington@olukai.com","by3pierce@gmail.com","cadwell@mac.com","calbears82@comcast.net","calcio109@hotmail.com","calmer11@gmail.com","camille.robinson24@gmail.com","campagnuts@hotmail.com","candyje@gmail.com","canyodl@aol.com","caples69@hotmail.com","carbonneau.jeff@gmail.com","carlacostamagna@gmail.com","carrie.bachler@gmail.com","carrievs@hotmail.com","caseysousa2014@gmail.com","caycejlegaspi@gmail.com","cbflynn@gmail.com","cfudge1@gmail.com","chad.mcgavock@gmail.com","chameleonmusic@gmail.com","charlie.lowrey@gmail.com","chicagokaeli@gmail.com","chris.kilroy@gmail.com","chris.m.raymond@icloud.com","chris.pernicano@gmail.com","chris@cfmatthews.com","chrisberthkc@aol.com","chriskrameremail@gmail.com","christine_lupinski@yahoo.com","christopher.pederson@hotmail.com","christopher.slade.jackson@gmail.com","cicero70@juno.com","cjmarzano@gmail.com","classynfun@Gmail.com","claym@cunningcoder.org","Clyde@DrClydeWilson.com","cm318llc@yahoo.com","cmdln@thecommandline.net","cnelson0@chicagobooth.edu","courtney@bidwellinsurance.com","courtney_banach@yahoo.com","cowboywerks@yahoo.com","cp_brown10@yahoo.com","cpsava@uwalumni.com","cr4kennedy@msn.com","craig@cheslog.com","craneae@gmail.com","crashlvmc@gmail.com","crizchin@hotmail.com","crklein@eckerd.edu","cshafir@gmail.com","cshihady@yahoo.com","ctgordo@gmail.com","curv.miller@gmail.com","danbierman89@yahoo.com","daniel.venning@gmail.com","danielleott@gmail.com","danny@tripping.com","danspears@sbcglobal.net","darius@dunlaps.net","darnaud@sbcglobal.net","darren.winkley+noblebrewerbeer@gmail.com","darrylb@intpkgsys.com","dava@Noise13.com","dave@shaver.us","dave.tichy@gmail.com","dave031@gmail.com","davewoosley@gmail.com","david@pocketderm.com","davidcogley@gmail.com","davidh2@gmail.com","davukii@sbcglobal.net","dbor1@allstate.com","dddubesq@hotmail.com","deborahwalker@earthlink.net","decorte.house@gmail.com","deletemeaccount@gmail.com","devin@americancupcake.com","dietz_michael@hotmail.com","dimersh@yahoo.com","diparshi@yahoo.com","djenkins0731@gmail.com","djvnet@gmail.com","dkrug@tband.net","dmcdona@gmail.com","dmlcoch@gmail.com","donallmc@gmail.com","dougiedigital@gmail.com","dpweave@hotmail.com","driz8@att.net","duckhookdaniel@comcast.net","dwyer.ed@gmail.com","ebelcherjr@gmail.com","edbergal@gmail.com","egdrewseph@gmail.com","ejculbert@gmail.com","ekenley@gmail.com","gregfiore@gmail.com","emaiwald@fred.net","embjacobi76@aol.com","emi@nahmo.com","emily.standiford@gmail.com","eric@paradistribe.net","eric.c.martinez@gmail.com","ericdowen@gmail.com","ericolivier7@gmail.com","erikadrummond@gmail.com","eugenecat@gmail.com","evaposner@gmail.com","f.ramirez01@yahoo.com","fairedescourses@hotmail.com","fandscollision@aol.com","firmeaqui@aol.com","fredorth@fuse.net","gabranto@gmail.com","galen.rasche@gmail.com","gardenman007@yahoo.com","gardinercolin@gmail.com","garth.clardy@gmail.com","gary@fortfedora.com","genefitzpatrick@gmail.com","george@nextglass.co","gill.312@osu.edu","gina.buchanan@gmail.com","bills@codeable.net","goobur@hotmail.com","gormanjacobv@gmail.com","grafpoo@gmail.com","greg@breetz.net","gregorybritt@gmail.com","GREGPIPER@GMAIL.COM","gregtoswald@gmail.com","gretencord@gmail.com","griffith.joseph@gmail.com","gwfrankpsu@mac.com","haleysharp925@gmail.com","hannahps@outlook.com","hardluck@email.com","hariganti@gmail.com","harold.gimenez@gmail.com","harrisw5@yahoo.com","hdomega@mail.com","heatherbinda@hotmail.com","heidi.cozart@gmail.com","hello@piquecooking.com","henryandjune@gmail.com","hernandezsergio@gmail.com","heytoughguy@hotmail.com","hft.rock@gmail.com","hilary.dykes@gmail.com","hlstier@aol.com","HoldenT@ent.wustl.edu","holympus@gmail.com","houston.hannah@gmail.com","ike6013@gmail.com","illrepute.ir@gmail.com","inflamez5@hotmail.com","irishmarine@gmail.com","j.minalga@icloud.com","jackpiece@gmail.com","Jacob.Schoster@Gmail.com","jake.gibson@gmail.com","jakegreg1@yahoo.com","jameseyarbrough@gmail.com","jamie.f.orr@gmail.com","janessahunter@gmail.com","jaredschmidt9@gmail.com","jasonmailhot@gmail.com","jasonwilliams.w@gmail.com","jasterme@gmail.com","jbauer23@gmail.com","jbrianlee88@gmail.com","jcfranks@comcast.net","jdbake@gmail.com","jdpitte@gmail.com","jeff@sfindie.com","jeff@allbydesign.com","jeffsrepair@gmail.com","jenn@highheelgolfer.com","jenn.naomi@gmail.com","jenzachryan@yahoo.com","jeremynaymik@hotmail.com","jesse.czelusta@gmail.com","jester36@pacbell.net","jfarnes@warpmail.net","jfredcpa@yahoo.com","jhargarther86@yahoo.com","jim_jesse@yahoo.com","jimgoschy25@gmail.com","jkezekiel@gmail.com","jlajugie@aol.com","jlamphier@gmail.com","jmartinsen@sbcglobal.net","jnis718@yahoo.com","joannafdoyle@gmail.com","jodi.schulz@gmail.com","johannaweintraub@gmail.com","john@spiller.org","johnagower@gmail.com","Johnathan_R_Greene@hotmail.com","johnpkiernan@gmail.com","JohnTBlazer@aol.com","jon.doe123@aol.com","jonahspear@gmail.com","jonathan.pellish@gmail.com","jonathansimpson926@yahoo.com","jonbonny@gmail.com","jonhyland@outlook.com","jono.fish@gmail.com","jordan@withoutconclusion.com","Joseph.A.Santanello@nasa.gov","joseph.cappellino@gmail.com","josh_brinson@hotmail.com","jpcaridi@gmail.com","jpglenn84@gmail.com","jpjoyce44@gmail.com","jpkanfield@outlook.com","jpshen@alum.mit.edu","jrobinster@gmail.com","jsilcox@yahoo.com","jstcyr32@yahoo.com","jt.neville@gmail.com","jtauman@nc.rr.com","juliaclairewilhelm@gmail.com","julie_house@hotmail.com","justin.g.wong@gmail.com","justin.rainbow@gmail.com","justinpincar@gmail.com","justinswhite11@gmail.com","jwbjr69@verizon.net","jwhannam@icloud.com","jwstewartddg67@gmail.com","jyri.tuulos@gmail.com","jzenoz001@gmail.com","karlacn@outlook.com","karlm79@icloud.com","katebaratta@gmail.com","kathleencarlson82@gmail.com","kathystafford2014@yahoo.com","kbennett509@gmail.com","kblomquist.2010@gmail.com","kearsdogg@yahoo.com","keith.rode@gmail.com","kendrakae@msn.com","kenneth.m.cleary@gmail.com","kevin.b.crocker@gmail.com","kfawke@gmail.com","Khickey05@gmail.com","kimmysauer@hotmail.com","kiralaura@gmail.com","kirariken@gmail.com","Kirkpatrick1703@gmail.com","kirsten.g.schulte@gmail.com","kkamps580@yahoo.com","kkaplinska@outlook.com","kmp1968@yahoo.com","koos_h@yahoo.com","kphenn@gmail.com","kplon42@gmail.com","krings_jason@yahoo.com","kris.kazaks@gmail.com","kruegern@gmail.com","kwaynenorton@gmail.com","kyle.roderick@gmail.com","kyle.ryan.cox@gmail.com","kylevitek@gmail.com","l.chris.prichard@gmail.com","lacey.fabrizio@gmail.com","lairdscustoms@gmail.com","larry@larryrtaylor.com","lat0730@yahoo.com","lauren.bartos@gmail.com","lawieland@gmail.com","lawman357kc@gmail.com","ldieckhoff@comcast.net","leblond.mel@gmail.com","levircurtis@gmail.com","lightdar@aol.com","ligia.ki@girlspintout.org","lionel@ram-tex.com","Lisa.wojcicki@gmail.com","lisab.nguyen1@gmail.com","lizymae@hotmail.com","lmarino314@gmail.com","lnealjr@wildblue.net","lorax429@gmail.com","lordkrishna@gmail.com","loriarbuckle@yahoo.com","lornamdillon@gmail.com","luistrujillo2342@gmail.com","m@thew.us","m.oconnor@me.com","m.w.morgan@outlook.com","mail@maxmatveev.com","manonnen@gmail.com","mwoodburn1@aol.com","mark@thinkvein.com","mark.dreschler@gmail.com","marksanford@windstream.net","markwweiss@yahoo.com","martin.jeffrey.83@gmail.com","marybeth_koss@yahoo.com","marygerard@earthlink.net","mathew.biggins@gmail.com","mathew.smeltzer@gmail.com","matthew.kuikman@gmail.com","matthew.snider@gmail.com","matthew.sturm@gmail.com","mbfleck@mtu.edu","mcastillon10@gmail.com","mcclain.nick@gmail.com","mcguckinaj@gmail.com","mdecarlo4@gmail.com","mebalzitch@yahoo.com","megan.spangler.86@gmail.com","meganrose90@gmail.com","messofnik@gmail.com","metzmichael@yahoo.com","mgolla67@cox.net","mhoskins5388@gmail.com","michelle.nalabandian@gmail.com","mike_patel@cox.net","mike.pritchard.2010@gmail.com","mikecrcauto@aol.com","milljs@hotmail.com","minfin17@gmail.com","minxti@gmail.com","mj.espiritu@gmail.com","mjfalter@gmail.com","mjscheuermann@gmail.com","molly.h.giles@gmail.com","mollymparnell@gmail.com","movinvan@gmail.com","mparker2384@gmail.com","mpucho30@gmail.com","mr.blair@gmail.com","mraumann@yahoo.com","mrdlhowell@sbcglobal.net","msajtp@yahoo.com","msbrocchi1@gmail.com","mstiddom@yahoo.com","mstroh90@gmail.com","mtornado99@aol.com","mttsmll@gmail.com","mulcahyr1@gmail.com","mvelesz@gmail.com","mynameisjoshsilverman@gmail.com","nancy.dow@gmail.com","napagood@gmail.com","Natalie@noblebrewerbeer.com","natalie@zerocoordinate.com","nate@nec-72.com","nate.cramton@gmail.com","Nathanael.robbins@sykes.com","nathanarendt@gmail.com","ncsteve173@gmail.com","ndh_2@hotmail.com","neillessem@gmail.com","nicholaskaat@mac.com","nick.wathen@gmail.com","nickd717@gmail.com","nicortes11@gmail.com","nkordecki@gmail.com","noblebrewer@mdove.com","noblebrewer@pfmj.me","noblebrewer@allenofmn.com","nolan_collins@yahoo.com","norman.eggen@comcast.net","ntrav19@gmail.com","ODPat@aol.com","okiponger@yahoo.com","oldyrok@hotmail.com","oneunderscoretwo@hotmail.com","ontapoftheworld@gmail.com","onthe44@gmail.com","osuksig@gmail.com","p.ogden.armour@gmail.com","paine_tim@yahoo.com","pam.creel@verizon.net","parjco@yahoo.com","parker.corey@gmail.com","pastlife@rocketmail.com","pat.boyce@gmail.com","patcreery@hotmail.com","patrick@qbrews.com","patterson.stu@gmail.com","paty.torres@gmail.com","paul.jacob@outlook.com","paul.rotatori@gmail.com","pcostanza@cox.net","pefmiester@gmail.com","penguin482@gmail.com","pereavision@gmail.com","pgroezinger@att.net","pguensler@hotmail.com","pharrison09@msn.com","phidelt071@gmail.com","phillip.l.yoo@gmail.com","plasmar2000@yahoo.com","poe.gary@gmail.com","poppitito@sbcglobal.net","psmuldow@gmail.com","r.beardsley777@gmail.com","r.chappa@gmail.com","rachael.chiappetta@gmail.com","rachel.l.riccio@gmail.com","radikalz@gmail.com","ratctattooer@gmail.com","ravenvii@gmail.com","rblockston@gmail.com","RCKYMTNLEGACY@GMAIL.COM","rdhislop@gmail.com","re.thompsoniii@gmail.com","reelbigairman@yahoo.com","renae1979@yahoo.com","rfrausto1@mac.com","rgraves@aspiration.com","rhenders@ch2m.com","rich@murbysworld.com","richard.jenkins@gmail.com","rickswa01@gmail.com","RIrons56@aol.com","rjcrab@comcast.net","rmangone@msn.com","rmccon@gmail.com","rnsmith2@gmail.com","robert_kestenbaum@yahoo.com","robert.hurtado87@gmail.com","robert.wynne@sbcglobal.net","robhuett@hotmail.com","rocci.reg@gmail.com","rockross@att.net","rodshough@numail.org","roguepanda74@gmail.com","roryyegerman@gmail.com","rosebroome@gmail.com","rrokoff@gmail.com","rtcaudio@gmail.com","rudypenajr@gmail.com","ryan@mamanze.com","ryan.oconnell@nakedwines.com","ryanarce4@gmail.com","ryanorlandokelly@gmail.com","RyanShirley@inbox.com","ryanswenson81@aol.com","rylanwolfe@gmail.com","s.royal330@comcast.net","sales+test@noblebrewerbeer.com","sam@samstromberg.com","SAMSTRAPASON@GMAIL.COM","samuelstaley@gmail.com","sandlotvideo@hotmail.com","sandymkasten@gmail.com","sanphrancisco@hotmail.com","sara.cederberg@gmail.com","sarah.fafard@gmail.com","sarah.heckroth@gmail.com","sarah.pinner@rabobank.com","sbanks@wkep.com","sbonia@hotmail.com","scarrittjd@hotmail.com","schmitzre@hotmail.com","sck3k@virginia.edu","scott.call@gmail.com","Scott.herzog@yahoo.com","scott.nickels@gmail.com","scottmurcray@me.com","scubachase@gmail.com","sean@funcheap.com","seanmhurdiss@gmail.com","seanparks.sp@gmail.com","sflannagan@gmail.com","sgstocking@gmail.com","shannontstark@gmail.com","shariglidden@msn.com","shelby.brunner@thermofisher.com","simerson@lycos.com","sjohnston76@gmail.com","skessary33@gmail.com","skipcrust@gmail.com","skjohnson73@gmail.com","slck816@hotmail.com","sleepmd@gmail.com","smccart@uw.edu","smith344@csusm.edu","smurf_shoelaces@yahoo.com","SoccerDude3366@gmail.com","sodalane.ristu@gmail.com","somaruby@gmail.com","spytdi@gmail.com","sreathaford@yahoo.com","stanleyjw@gmail.com","stapleskd@gmail.com","steiner25@cox.net","steph.bradley@gmail.com","stephaniekotylo@gmail.com","stephen_lanza@comcast.net","stephen.lanyi@gmail.com","stephenjpack@hotmail.com","steve.mcdevitt@gmail.com","steve.wishnousky@gmail.com","sthomp675@yahoo.com","stumoyer@gmail.com","sungkim@gmail.com","susantsay@hotmail.com","tahoecrow@yahoo.com","tapacob@gmail.com","taphappyadventures@gmail.com","taylor.paul.marshall@gmail.com","tcamp0000@yahoo.com","tedjcole@gmail.com","terzuoli@gmail.com","test123455@gmail.com","testytest@gmail.com","thenathanpierce@gmail.com","thetoolman291@sbcglobal.net","tiffany.iino@sbcglobal.net","tiffanypatrick7@gmail.con","Timdog1650@yahoo.com","timizaki@gmail.com","timothy.ondrey1@gmail.com","tinnna@gmail.com","tjcasser@gmail.com","tkimmel87@gmail.com","tmbeliveau@gmail.com","tokiowie@gmail.com","tom_narr@yahoo.com","tony.wiedenski@gmail.com","too_solipsist@hotmail.com","tparnell@gmail.com","travertischio@gmail.com","travisoliver2@gmail.com","trichter@live.com","troywdbrn0@gmail.com","tskelt@gmail.com","tyrusmanuel@gmail.com","vaanders@gmail.com","vahlkamp@gmail.com","vergelge@gmail.com","victoria.l.g@gmail.com","w4lterwh1te@gmail.com","waldocastellanos@gmail.com","wdpp8ntba11er@gmail.com","william.leiter@gmail.com","winter@faulk.me","wkp4fightingirish@gmail.com","wmidkiff314@gmail.com","xesr@aol.com","xxxboogiexxx@yahoo.com","yeokp0909@gmail.com","youdoppleganger@aol.com","zachkelling@gmail.com","zedzed@gmail.com"
	]

//wizard();

function getNextCustomer(){
	if (emailArray.length > 0) {
		var email = emailArray.pop();
		getID(email);
	} else {
		console.log("finished");
	}
}

function wizard(){
  sleep.sleep(2)
  getNextCustomer();
}; 

function getID(data) {
	var email = data
	var options = { method: 'GET',
		url: keystone.get('shopify_api')+'/admin/customers/search.json',
		qs: { query: 'email:'+email },
		headers: { 'content-type': 'application/json' } };

	request(options, function (error, response, body) {
		if (error) throw new Error(error);
		//console.log(body);
		console.info("bucket response level: "+response.headers.http_x_shopify_shop_api_call_limit);
		body = JSON.parse(body)
		if (body.customers.length > 0){
			var id = body.customers[0].id;
			console.log(id);
			updateCustomer(email, id)
		} else {
			wizard();
		}
	});
}

function updateCustomer(email, id){
	console.log('updating '+email+' '+id);
	var email = email;
	var id = id;
	var options = { 
		method: 'PUT',
		url: keystone.get('shopify_api')+'/admin/customers/'+id+'.json',
		headers: { 'content-type': 'application/json' },
  		body: { customer: { id: id, tags: 'Active Subscriber' } },
  		json: true
 	};
	request(options, function (error, response, body) {
		if (error) throw new Error(error);
		console.log(body.customer.email);
		console.log(body.customer.tags);
		wizard();
	});
}

