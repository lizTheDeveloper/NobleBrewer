define(["jquery","plugin-dependencies","plugin-components/image-loader","plugin-components/preview-menu/view","text!./main.html","css!./main.css"],function(e,i,t,o,n){return function(a){var s,r,d,l,c,h,g,m=a.toJSON(),u=!1,f=e(document),p=e(n),v=p.find(".file-wrap"),w=p.find(".file-inset"),y=(p.find(".file-foot"),p.find(".file-controls")),C=new o,z=e('<p class="zoom"><a class="icon-btn zoom-in zoom-toggle-btn"></a></p>'),k=e('<div class="thumbnail-loading"></div>'),b=e('<p class="layers-toggle"><a class="icon-btn layers-toggle-btn"></a></p>'),H=i.utils.getCurrentBasePath(),M=/^#?link/.test(H),x=function(){var e={id:m.id,modified:m.modified,icon:m._defaultIcon,height:h||m.height,width:g||m.width,page:m._page,version:c?d.revision_number:m._version,versionHead:m._versionHead,layers:m._layers,type:m.type,name:m.name,link:m.linkId},i=function(e,i,t){h=t,g=i,A(e[0],e.attr("src"))};w.append(k),t(e,i)},A=function(e,i){if(i==r&&k.remove(),s)try{w.empty()}catch(t){}r=i,s=e,e.setAttribute("draggable",!1),w.empty().append(e).addClass("loaded"),z.off("click",O),y.append(z.on("click",O)),m.layer&&m.layer.layers.length>0&&b.off("click",J),P()},P=function(){if(!l)return void N.sizeChange();var t=60,o=250,n=i.utils.getViewport(),a=n.width<600?!0:!1,s=h||m.height,r=g||m.width,d=r/s,c=u?n.height:Math.max(o,l.height),f=u?n.width:l.width,y=f/c,C=e(".file-controls").outerHeight(!0)||26,_=e("#footer").outerHeight(!0);(r>=f-t||s+C>c-_)&&(y>d?(t+=e(".version-preview-menu").length?e(".version-preview-menu").outerHeight(!0):0,r=Math.floor((c-2*t)*d),s=c-2*t):(s=Math.floor((f-1.5*t)/d),r=f-1.5*t)),p.css({width:u?f:"auto",height:a&&!u?s+C:c}),v.css({width:r,height:s,top:M&&!u||a&&!u?0:Math.max(0,Math.floor((c-s)/2)-C)}),w.css({width:r,height:s})},O=function(i){var t=p.find(".zoom-toggle-btn");u=!u,i&&i.stopPropagation(),u?(e(document).on("keyup",function(e){27==e.keyCode&&O()}),p.addClass("file-media-zoom"),p.closest(".share-page").addClass("file-media-zoom"),t.removeClass("zoom-in").addClass("zoom-out"),p.prepend(t.remove()),b.hide(),f.on("click",O),w.on("click",R)):(e(document).off("keyup"),p.removeClass("file-media-zoom"),p.closest(".share-page").removeClass("file-media-zoom"),t.removeClass("zoom-out").addClass("zoom-in"),p.find("p.zoom").append(t.remove()),b.show(),f.unbind("click",O),w.off("click",R)),P(l)},R=function(e){e.preventDefault(),e.stopPropagation()},I=function(e){e.get("_version")===e.get("_versionHead")?(C.remove(),p.removeClass("preview-version")):(C.setResource(e),p.prepend(C.render().$el),p.addClass("preview-version"))},J=function(){p.find(".layers-toggle").toggleClass("active"),N.trigger("rendition.layers.toggle")},N={$el:p,show:function(){x()},hide:function(){e(".layers-container").removeClass("show-layers"),e(".control-container").show(),b.removeClass("active"),p.remove()},updateMetadata:function(e){a=e,m=a.toJSON(),d=_.where(m.revisions,{revision_number:m._version})[0],c="undefined"!=typeof d,d&&d.width&&d.height&&(h=m._isAutoRotated?d.width:d.height,g=m._isAutoRotated?d.height:d.width);var i=e.changed;i._version>=0&&I(e),_.keys(i).indexOf("shared")>-1||("empty"!==m._layers?x():w.empty())},sizeChange:function(){var i=e("#oneup-content").outerHeight(!0)||e(".cc-ActivityPlugin-imgframe").outerHeight(!0),t=e(".media").outerWidth(!0)||e(".cc-ActivityPlugin-imgframe").outerWidth(!0);l={height:i,width:t},P(l)}};return N=_.extend(e({}),N)}});