define(["events","plugin-dependencies","text!./template.html","text!./layer_template.html","css!./template.css"],function(e,t,i,s){return i=t.utils.createTemplate(i),s=t.utils.createTemplate(s),Backbone.View.extend({className:"layers active",events:{"click .layer":"toggleLayer","click .reset":"resetLayers"},tree:null,initialize:function(){_.bindAll(this,"render","clearView","findSubtreeAndSetVisible","toggleLayer","insertLayer","resetLayers")},render:function(){var s=this.$el?this.$(".reset").hasClass("active"):!1;if(this.$el.html(i({translate:t.translate})),!this.model.get("layer"))return!1;var r=this.model.get("layer").layers,a={layers:this.getLayerTree(r)};return this.tree||(this.tree=a),_.each(this.tree.layers,this.insertLayer),s&&this.$(".reset").addClass("active"),e.on("clear_oneup_section",this.clearView),this.delegateEvents(this.events),this},clearView:function(){e.off("clear_oneup_section",this.clearView),this.model.unset("_layers"),delete this.tree,this.remove()},findSubtreeAndSetVisible:function(e,t,i,s){var r=this,a=!1;return e.layers?(_.each(e.layers,function(e){if(e.index==t)e.visible=i,r.findSubtreeAndSetVisible(e,t,i,s),a=i===!0;else if(e.layers&&e.layers.length>0){var l=r.findSubtreeAndSetVisible(e,t,i,s);l===!0&&i===!0&&(e.visible=l,a=!0)}e.visible===!0&&s.push(e.index)}),a):!1},getLayerTree:function(e){if(!Array.isArray(e))return null;var t=[[]];return e.forEach(function(e){if("layerSection"===e.type)if(e.editable===!1)t.push([]);else{var i=_.clone(e),s=t.pop();i.layers=s,_.last(t).unshift(i)}else _.last(t).unshift(_.clone(e))}),t.pop()},toggleLayer:function(e){var t="",i=[];if(this.$(".reset").addClass("active"),e&&e.target){e.target.id?t=e.target.id.replace("indicator_",""):e.target.className&&(t=e.target.className);var s=t.toString().replace(/layer_/g,"").replace(/name /g,"").replace(/icon /g,"");this.$("#layer_"+s).toggleClass("checked");var r=this.$("#layer_"+s).hasClass("checked");this.findSubtreeAndSetVisible(this.tree,s,r,i),i=_.isEmpty(i)?"empty":i,this.model.set("_layers",i)}return!1},insertLayer:function(e){var i=t.utils.htmlEncode(e.name);this.$(".layer_list").append(s({layer_index:e.index,checked:e.visible===!0?" checked":"",name:i}))},resetLayers:function(){return this.model.unset("_layers"),delete this.tree,this.$(".reset.sidebar_action").hide(),this.$(".reset").removeClass("active"),this.render(!0),!1}})});